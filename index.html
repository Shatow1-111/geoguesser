<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My GeoGuessr Clone</title>
    <link href='https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        #mly { flex: 2; background: #222; } /* Top: Street View */
        #map { flex: 1; height: 300px; }     /* Bottom: Guessing Map */
        .ui-panel { position: absolute; top: 10px; left: 10px; z-index: 1000; }
        button { padding: 10px 20px; background: #2ecc71; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="ui-panel">
        <button onclick="checkGuess()">SUBMIT GUESS</button>
    </div>

    <div id="mly"></div>
    <div id="map"></div>

    <script src='https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.js'></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Your API Token
        const MLY_TOKEN = 'MLY|26310050215287964|040380c26b7962fb3a60d6e62ad5d390';
        let targetLoc = null;
        let guessMarker = null;

        // 2. Setup the Street View
        const mly = new mapillary.Viewer({
            accessToken: MLY_TOKEN,
            container: 'mly',
            component: { cover: false }
        });

        // 3. Setup the Guessing Map
        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        map.on('click', (e) => {
            if (guessMarker) map.removeLayer(guessMarker);
            guessMarker = L.marker(e.latlng).addTo(map);
        });

        // 4. Randomizer Logic
        async function loadRandomPlace() {
            // Picking a random spot in Europe/USA for better coverage
            const lat = (Math.random() * 30) + 30; 
            const lng = (Math.random() * 60) - 20;

            const url = `https://graph.mapillary.com/images?access_token=${MLY_TOKEN}&fields=id,geometry&bbox=${lng-1},${lat-1},${lng+1},${lat+1}&is_pano=true&limit=1`;

            try {
                const res = await fetch(url);
                const json = await res.json();
                if (json.data && json.data.length > 0) {
                    targetLoc = { lat: json.data[0].geometry.coordinates[1], lng: json.data[0].geometry.coordinates[0] };
                    mly.moveTo(json.data[0].id);
                } else {
                    loadRandomPlace(); // Retry if we hit the ocean
                }
            } catch (e) { loadRandomPlace(); }
        }

        // 5. Check Score
        function checkGuess() {
            if (!guessMarker || !targetLoc) return alert("Click the map to guess first!");
            const dist = map.distance(guessMarker.getLatLng(), [targetLoc.lat, targetLoc.lng]) / 1000;
            alert(`You were ${dist.toFixed(2)} km away!`);
            location.reload(); // Restart game
        }

        loadRandomPlace();
    </script>
</body>
</html>
