<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GeoGuessr Fix</title>
    <link href='https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; background: #000; color: white; font-family: sans-serif; }
        #mly { flex: 2; width: 100%; background: #111; position: relative; }
        #map { flex: 1; width: 100%; border-top: 4px solid #333; }
        #debug { position: absolute; top: 70px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; font-size: 12px; z-index: 3000; border-radius: 5px; }
        .ui { position: absolute; top: 10px; left: 10px; z-index: 4000; }
        button { padding: 12px 20px; cursor: pointer; background: #2ecc71; color: white; border: none; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="ui">
        <button onclick="checkGuess()">SUBMIT GUESS</button>
    </div>

    <div id="debug">Status: Initializing...</div>

    <div id="mly"></div>
    <div id="map"></div>

    <script src='https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.js'></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const MLY_TOKEN = 'MLY|26310050215287964|040380c26b7962fb3a60d6e62ad5d390';
        const debug = document.getElementById('debug');
        let map, mly, guessMarker, targetLoc;

        function log(msg) { debug.innerText = "Status: " + msg; }

        window.onload = function() {
            log("Loading Map...");
            map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            map.on('click', (e) => {
                if (guessMarker) guessMarker.setLatLng(e.latlng);
                else guessMarker = L.marker(e.latlng).addTo(map);
            });

            mly = new mapillary.Viewer({
                accessToken: MLY_TOKEN,
                container: 'mly',
                component: { cover: false }
            });

            findImage();
        };

        async function findImage() {
            log("Searching for 360Â° view...");
            
            // List of high-coverage cities
            const cities = [
                { name: "London", lat: 51.5, lng: -0.12 },
                { name: "New York", lat: 40.7, lng: -74.0 },
                { name: "Paris", lat: 48.8, lng: 2.3 },
                { name: "Tokyo", lat: 35.6, lng: 139.6 }
            ];

            const spot = cities[Math.floor(Math.random() * cities.length)];
            const bbox = `${spot.lng - 0.5},${spot.lat - 0.5},${spot.lng + 0.5},${spot.lat + 0.5}`;
            
            // The API URL
            const url = `https://graph.mapillary.com/images?access_token=${MLY_TOKEN}&fields=id,geometry&bbox=${bbox}&is_pano=true&limit=5`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.data && data.data.length > 0) {
                    const img = data.data[Math.floor(Math.random() * data.data.length)];
                    targetLoc = {
